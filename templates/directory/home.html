{% extends "directory/base.html" %}
{% load static %}

{% block extra_styles %}
<style>
/* Messaging demo styles (paste into home.html) */
.person-card { position: relative; }
.msg-icon {
  position: absolute;
  right: 12px;
  top: 12px;
  width:36px;
  height:36px;
  border-radius:8px;
  display:inline-flex;
  align-items:center;
  justify-content:center;
  background:linear-gradient(180deg,#fff,#f3f4ff);
  border:1px solid rgba(15,23,42,0.06);
  box-shadow:0 6px 18px rgba(16,24,40,0.06);
  cursor:pointer;
  transition: transform .12s ease, box-shadow .12s ease;
  font-size:16px;
}
.msg-icon:hover { transform: translateY(-3px); box-shadow:0 10px 26px rgba(16,24,40,0.09); }

/* Modal */
.demo-msg-modal { display:none; position:fixed; inset:0; z-index:9999; align-items:center; justify-content:center; }
.demo-msg-modal.open { display:flex; }
.demo-msg-overlay { position:absolute; inset:0; background:rgba(6,8,15,0.55); }
.demo-msg-dialog {
  position:relative; width:min(900px,96%); max-height:88vh; overflow:auto;
  background:#fff; border-radius:12px; padding:18px; z-index:10000; box-shadow:0 30px 80px rgba(2,6,23,0.35);
  display:flex; gap:18px; flex-direction:column;
}
.demo-msg-header { display:flex; align-items:center; justify-content:space-between; gap:12px; }
.demo-msg-title { font-size:18px; font-weight:700; margin:0; }
.demo-msg-close { border:0; background:transparent; font-size:20px; cursor:pointer; }

/* composer */
.demo-composer { display:flex; gap:12px; align-items:flex-start; }
.demo-composer textarea { flex:1; min-height:110px; padding:12px; border-radius:8px; border:1px solid #e6e6e9; font-size:14px; resize:vertical; }
.demo-composer .meta { width:240px; display:flex; flex-direction:column; gap:8px; }
.demo-composer .meta input { padding:10px; border-radius:8px; border:1px solid #e6e6e9; }

/* messages area */
.demo-thread { margin-top:8px; display:flex; flex-direction:column; gap:10px; max-height:330px; overflow:auto; padding-right:6px; }
.bubble { max-width:78%; padding:10px 12px; border-radius:12px; line-height:1.3; font-size:14px; position:relative; }
.bubble.me { align-self:flex-end; background:linear-gradient(90deg,#6d28d9,#06b6d4); color:#fff; border-bottom-right-radius:6px; }
.bubble.them { align-self:flex-start; background:#f3f4f6; color:#111827; border-bottom-left-radius:6px; }

/* unsend button (shows only on messages you sent) */
.unsend-btn {
  position:absolute;
  top:6px;
  right:6px;
  background:rgba(255,255,255,0.9);
  border:1px solid rgba(0,0,0,0.06);
  padding:4px 6px;
  border-radius:6px;
  font-size:12px;
  color:#111827;
  cursor:pointer;
  display:none;
}
.bubble.me:hover .unsend-btn { display:inline-block; }

/* tiny timestamp */
.msg-ts { font-size:11px; color:#6b7280; margin-top:6px; }

/* toast */
.demo-toast { position:fixed; right:20px; bottom:20px; background:#111827; color:#fff; padding:10px 14px; border-radius:999px; box-shadow:0 10px 30px rgba(2,6,23,0.4); display:none; z-index:11000; cursor:pointer; }
.demo-toast.show { display:block; animation:pop .36s ease; }
.demo-toast .undo { color:#ffd; text-decoration:underline; margin-left:8px; font-weight:700; }
@keyframes pop { from { transform: translateY(8px); opacity:0 } to { transform: translateY(0); opacity:1 } }

@media (max-width:720px) {
  .demo-composer { flex-direction:column; }
  .demo-composer .meta { width:100%; order:2; }
  .demo-thread { max-height:220px; }
}

/* --- keep your existing page styles below (copied from your file) --- */
:root {
  --primary-blue: #007bff;
  --deep-purple: #6a00ff;
  --text-dark: #1f1f1f;
  --overlay-dark: rgba(255, 255, 255, 0.65);
  --shadow-md: 0 8px 20px rgba(0, 0, 0, 0.15);
}

/* basic page styles (search, cards) */
.search-form { display:flex; gap:12px; padding:16px; background: rgba(255,255,255,0.85); border-radius:12px; box-shadow:0 8px 20px rgba(0,0,0,0.12); margin-bottom:32px; }
.location-select { flex:0 0 210px; }
.search-input { flex:1 1 auto; }
.search-button { flex:0 0 auto; }
input[type="text"], select { width:100%; padding:12px 14px; border-radius:8px; border:1px solid #e0e0e0; background:white; font-size:15px; box-sizing:border-box; }
.search-btn { padding:11px 20px; border-radius:8px; border:none; background: linear-gradient(90deg,#007bff,#6a00ff); color:white; font-weight:600; cursor:pointer; }
.card { background-color: rgba(255,255,255,0.9); padding:20px; border-radius:12px; box-shadow:0 8px 20px rgba(0,0,0,0.1); border:1px solid rgba(255,255,255,0.6); backdrop-filter: blur(8px); transition: transform .2s, box-shadow .2s; }
.card:hover { transform: translateY(-3px); box-shadow:0 12px 26px rgba(0,0,0,0.15); }
.name-link { color: var(--text-dark); text-decoration:none; }
.name-link:hover { color:#007bff; }
.card-title { margin-bottom:5px; font-size:1.25rem; }
.card-detail { font-size:.95rem; color:var(--secondary-text); margin-bottom:4px; }
.card-contact { margin-top:10px; font-size:.9rem; }
.card-contact a { text-decoration: underline; }
.separator { margin: 0 5px; color: var(--border-color); }
.no-results { padding:20px; grid-column: 1 / -1; text-align:center; background-color:#fff3cd; color:#856404; border-radius:8px; }
</style>
{% endblock extra_styles %}

{% block title %}Directory Search{% endblock %}

{% block content %}
<h1>Who to Ask â€” Directory</h1>

<!-- SEARCH BAR -->
<form method="get" class="search-form">

  <!-- LOCATION DROPDOWN -->
  <div class="location-select">
    <select name="location">
      <option value="">All locations</option>
      {% for loc in locations %}
        <option value="{{ loc.id }}" {% if request.GET.location == loc.id|stringformat:"s" %}selected{% endif %}>
          {{ loc.name }}
        </option>
      {% endfor %}
    </select>
  </div>

  <!-- FULL-WIDTH SEARCH INPUT -->
  <div class="search-input">
    <input name="q" type="text" placeholder="Search name, role, email..." value="{{ q }}">
  </div>

  <!-- SEARCH BUTTON -->
  <div class="search-button">
    <button type="submit" class="search-btn">Search</button>
  </div>

</form>

<!-- DIRECTORY GRID -->
<div class="grid">
  {% for p in people %}
    <div class="card person-card" data-person-id="{{ p.id }}">

      <!-- message icon (top-right) -->
      <div
        class="msg-icon"
        data-person-id="{{ p.id }}"
        data-person-name="{{ p.display_name|default:p.first_name }}"
        title="Message {{ p.display_name|default:p.first_name }}">âœ‰</div>

      <!-- NAME (NO UNDERLINE) -->
      <h3 class="card-title">
        <a class="name-link" href="{% url 'directory:person_detail' p.id %}">
          {{ p.display_name|default:p.first_name }}
        </a>
      </h3>

      <!-- ROLE + DEPARTMENT -->
      <div class="card-detail role">{{ p.role }}</div>
      <div class="card-detail department">{{ p.department }}</div>

      <!-- EMAIL + PHONE (KEEP UNDERLINE) -->
      <div class="card-contact">
        <a href="mailto:{{ p.email }}" title="Email">{{ p.email }}</a>
        <span class="separator">|</span>
        <a href="tel:{{ p.phone }}" title="Phone">{{ p.phone }}</a>
      </div>

      <!-- small message preview (demo only) -->
      <div class="card-msg-preview" style="margin-top:12px;color:#6b7280;font-size:13px;">
        No messages (demo)
      </div>

    </div>
  {% empty %}
    <div class="no-results">
      <p>ðŸ˜” No people found matching your criteria. Try broadening your search.</p>
    </div>
  {% endfor %}
</div>

<!-- Demo messaging modal (only one on page) -->
<div id="demo-msg-modal" class="demo-msg-modal" aria-hidden="true">
  <div class="demo-msg-overlay" aria-hidden="true"></div>
  <div class="demo-msg-dialog" role="dialog" aria-modal="true" aria-labelledby="demo-msg-title">
    <div class="demo-msg-header">
      <h3 id="demo-msg-title" class="demo-msg-title">Message</h3>
      <button id="demo-msg-close" class="demo-msg-close" aria-label="Close">âœ•</button>
    </div>

    <!-- thread -->
    <div id="demo-thread" class="demo-thread" aria-live="polite">
      <div style="color:#6b7280; font-size:14px;">No messages yet. This demo stores messages in your browser.</div>
    </div>

    <!-- composer -->
    <div class="demo-composer" style="margin-top:10px;">
      <textarea id="demo-body" placeholder="Type your message..." aria-label="Message body"></textarea>
      <div class="meta">
        <input id="demo-subject" placeholder="Subject (optional)" />
        <div style="display:flex; gap:8px; margin-top:8px;">
          <button id="demo-send" style="flex:1; padding:10px; border-radius:8px; border:0; background:linear-gradient(90deg,#6d28d9,#06b6d4); color:#fff; cursor:pointer;">Send demo message</button>
          <button id="demo-clear" style="padding:10px; border-radius:8px; border:1px solid #e6e6e9; background:#fff; cursor:pointer;">Clear</button>
        </div>
      </div>
    </div>
  </div>
</div>

<div id="demo-toast" class="demo-toast" role="status" aria-live="polite">Saved (demo)</div>

<!-- Demo script -->
<script>
(function(){
  const STORAGE_KEY = 'demo_messages_v1';
  function loadMessages(){ try { return JSON.parse(localStorage.getItem(STORAGE_KEY)||'{}'); } catch(e){ return {}; } }
  function saveMessages(obj){ localStorage.setItem(STORAGE_KEY, JSON.stringify(obj)); }
  function fmtTs(ts){ const d=new Date(ts); return d.toLocaleString([], { hour:'2-digit', minute:'2-digit' }); }

  const modal = document.getElementById('demo-msg-modal');
  const overlay = document.querySelector('.demo-msg-overlay');
  const closeBtn = document.getElementById('demo-msg-close');
  const titleEl = document.getElementById('demo-msg-title');
  const threadEl = document.getElementById('demo-thread');
  const bodyEl = document.getElementById('demo-body');
  const subjectEl = document.getElementById('demo-subject');
  const sendBtn = document.getElementById('demo-send');
  const clearBtn = document.getElementById('demo-clear');
  const toast = document.getElementById('demo-toast');

  let activePersonId = null;
  let activePersonName = '';

  // For undo support:
  let lastRemoved = null; // { personId, msg, timeoutId }

  function openFor(personId, personName){
    activePersonId = String(personId);
    activePersonName = personName || 'Person';
    titleEl.textContent = `Message ${activePersonName} â€” demo`;
    renderThread();
    bodyEl.value = '';
    subjectEl.value = '';
    modal.classList.add('open'); document.documentElement.style.overflow = 'hidden';
  }
  function closeModal(){ modal.classList.remove('open'); document.documentElement.style.overflow = ''; }

  function renderThread(){
    threadEl.innerHTML = '';
    const store = loadMessages();
    const arr = (store[activePersonId] || []);
    if(arr.length === 0){
      threadEl.innerHTML = '<div style="color:#6b7280; font-size:14px;">No messages yet. This demo stores messages in your browser.</div>';
      return;
    }
    arr.forEach(msg=>{
      const div = document.createElement('div');
      div.className = 'bubble ' + (msg.from === 'me' ? 'me' : 'them');
      // store ts attr so we can unsend
      div.setAttribute('data-ts', msg.ts);
      const inner = document.createElement('div');
      inner.innerHTML = `${msg.body.replace(/\n/g,'<br>')}`;
      div.appendChild(inner);

      const tsDiv = document.createElement('div');
      tsDiv.className = 'msg-ts';
      tsDiv.textContent = (msg.subject ? (msg.subject + ' Â· ') : '') + fmtTs(msg.ts);
      div.appendChild(tsDiv);

      if(msg.from === 'me'){
        const unsend = document.createElement('button');
        unsend.className = 'unsend-btn';
        unsend.setAttribute('data-ts', msg.ts);
        unsend.title = 'Unsend';
        unsend.textContent = 'Unsend';
        div.appendChild(unsend);
      }

      threadEl.appendChild(div);
    });
    threadEl.scrollTop = threadEl.scrollHeight;
  }

  function renderCardPreviews(){
    const store = loadMessages();
    document.querySelectorAll('.person-card').forEach(card=>{
      const pid = String(card.dataset.personId || card.getAttribute('data-person-id'));
      const preview = card.querySelector('.card-msg-preview');
      if(!preview) return;
      const arr = (store[pid] || []);
      if(arr.length === 0){
        preview.innerHTML = 'No messages (demo)';
      } else {
        const last = arr[arr.length-1];
        const who = last.from==='me' ? 'You' : (last.from_name || 'Them');
        preview.innerHTML = `<strong>${who}:</strong> ${shorten(last.body,60)}`;
      }
    });
  }

  function shorten(s,n){ return s.length>n ? s.slice(0,n-1)+'â€¦' : s; }

  function sendDemoMessage(){
    const body = bodyEl.value.trim(); const subj = subjectEl.value.trim();
    if(!body){ showToast('Please type a message'); return; }
    const store = loadMessages();
    if(!store[activePersonId]) store[activePersonId]=[];
    const now = Date.now();
    store[activePersonId].push({ from:'me', from_name:'You', subject:subj, body:body, ts:now });
    saveMessages(store); renderThread(); renderCardPreviews(); showToast('Saved (demo)');

    setTimeout(()=>{
      const reply = { from:'them', from_name: activePersonName, subject:'', body: "Thanks â€” got your message (demo reply).", ts: Date.now() };
      const s2 = loadMessages(); s2[activePersonId].push(reply); saveMessages(s2); renderThread(); renderCardPreviews(); showToast('Auto-reply received (demo)');
    }, 800);
  }

  // UNSEND: remove a message (by ts) and allow undo
  function unsendMessage(personId, ts){
    const pid = String(personId);
    const store = loadMessages();
    const arr = store[pid] || [];
    const idx = arr.findIndex(m => String(m.ts) === String(ts));
    if(idx === -1) return;
    const removed = arr.splice(idx,1)[0];
    saveMessages(store);
    renderThread();
    renderCardPreviews();

    // clear previous pending undo
    if(lastRemoved && lastRemoved.timeoutId) clearTimeout(lastRemoved.timeoutId);

    // store lastRemoved with timeout to allow undo
    const timeoutId = setTimeout(()=>{
      lastRemoved = null;
      hideToast();
    }, 6000);

    lastRemoved = { personId: pid, msg: removed, timeoutId: timeoutId };

    // show toast with undo affordance
    showToastWithUndo('Message unsent â€” Click to undo', undoLastRemoved);
  }

  function undoLastRemoved(){
    if(!lastRemoved) return;
    const store = loadMessages();
    const pid = lastRemoved.personId;
    if(!store[pid]) store[pid] = [];
    store[pid].push(lastRemoved.msg);
    // sort by ts to keep chronological order
    store[pid].sort((a,b)=>a.ts - b.ts);
    saveMessages(store);
    renderThread();
    renderCardPreviews();
    // clear undo
    if(lastRemoved.timeoutId) clearTimeout(lastRemoved.timeoutId);
    lastRemoved = null;
    showToast('Restored');
  }

  let toastTimer = null;
  function showToast(msg){
    toast.textContent = msg;
    toast.classList.add('show');
    // make clickable area not remove undo (simple toast)
    clearTimeout(toastTimer);
    toastTimer = setTimeout(()=>{ toast.classList.remove('show'); }, 1800);
  }

  function showToastWithUndo(msg, undoHandler){
    // set innerHTML to include undo action label
    toast.innerHTML = `${escapeHtml(msg)} <span class="undo">Undo</span>`;
    // show toast
    toast.classList.add('show');
    // click on toast or undo span triggers undo
    function onToastClick(){ undoHandler(); hideToast(); }
    toast.addEventListener('click', onToastClick, { once:true });
    // auto-hide after 6s and clear lastRemoved
    clearTimeout(toastTimer);
    toastTimer = setTimeout(()=>{ hideToast(); lastRemoved = null; }, 6000);
  }

  function hideToast(){
    toast.classList.remove('show');
    toast.innerHTML = 'Saved (demo)';
    clearTimeout(toastTimer);
  }

  function escapeHtml(s){ return String(s).replace(/[&<>"']/g, function(m){ return ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m]); }); }

  // event delegation: unsend buttons inside thread
  threadEl.addEventListener('click', (e)=>{
    const btn = e.target.closest('.unsend-btn');
    if(btn){
      const ts = btn.getAttribute('data-ts');
      unsendMessage(activePersonId, ts);
    }
  });

  document.querySelectorAll('.msg-icon').forEach(btn=>{
    btn.addEventListener('click', ()=> {
      const pid = btn.getAttribute('data-person-id') || btn.dataset.personId;
      const pname = btn.getAttribute('data-person-name') || btn.dataset.personName || '';
      openFor(pid, pname);
    });
  });

  closeBtn.addEventListener('click', closeModal);
  overlay.addEventListener('click', closeModal);
  sendBtn.addEventListener('click', sendDemoMessage);
  clearBtn.addEventListener('click', ()=>{ bodyEl.value=''; subjectEl.value=''; });
  bodyEl.addEventListener('keydown', (e)=>{ if((e.ctrlKey || e.metaKey) && e.key==='Enter'){ sendDemoMessage(); } });

  renderCardPreviews();
  window.demoOpenMessage = openFor;
})();
</script>

{% endblock %}

